/**
 * Prisma Schema for Collaborative AI Productivity App
 * 
 * Database: SQLite (development) / PostgreSQL (production)
 * ORM: Prisma 5.7.1
 * 
 * Models:
 * - User: Application users (students, team members, AI agent)
 * - Team: Collaborative workspaces
 * - TeamMember: Many-to-many join table for User <-> Team
 * - Message: Chat messages (text, AI content, files)
 * 
 * Conventions:
 * - All IDs are UUIDs (String @id @default(uuid()))
 * - Timestamps use DateTime with @default(now())
 * - Relations use explicit join tables (no implicit many-to-many)
 * - JSON fields for flexible metadata
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid())
  name            String
  email           String?       @unique
  avatar          String?
  role            String        // 'member' | 'admin' | 'agent'
  createdAt       DateTime      @default(now())
  
  teamMemberships TeamMember[]
  messages        Message[]
}

model Team {
  id              String        @id @default(uuid())
  name            String
  isChimeEnabled  Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  teamMemberships TeamMember[]
  messages        Message[]
  aiInsights      AIInsight[]
  chimeLogs       ChimeLog[]
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  teamRole String?  // 'owner' | 'admin' | 'member'
  joinedAt DateTime @default(now())
  
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
}

model Message {
  id          String    @id @default(uuid())
  teamId      String
  authorId    String
  content     String
  contentType String    // 'text' | 'ai_longform' | 'notebook' | 'file'
  createdAt   DateTime  @default(now())
  metadata    String?   // JSON string for flexible data
  
  // Phase 4: Embedding fields for RAG
  embeddingId String?   // Pinecone vector ID
  embeddedAt  DateTime? // When embedding was generated
  
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@index([teamId, createdAt])
  @@index([embeddingId])
}

model AIInsight {
  id                String   @id @default(uuid())
  teamId            String
  type              String   // 'summary' | 'action' | 'suggestion' | 'analysis' | 'code' | 'document'
  title             String
  content           String
  priority          String?  // 'low' | 'medium' | 'high'
  tags              String?  // JSON array
  createdAt         DateTime @default(now())
  relatedMessageIds String?  // JSON array
  metadata          String?  // JSON string for chime rule metadata
  
  team              Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId, createdAt])
}

model ChimeRule {
  id              String     @id @default(uuid())
  name            String
  type            String     // 'pattern' | 'threshold' | 'semantic' | 'schedule' | 'hybrid'
  enabled         Boolean    @default(true)
  priority        String     // 'low' | 'medium' | 'high' | 'critical'
  cooldownMinutes Int        @default(30)
  conditions      String     // JSON serialized conditions
  action          String     // JSON serialized action config
  teamId          String?    // Optional: team-specific rule (null = global)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  chimeLogs       ChimeLog[]
  
  @@index([teamId, enabled])
}

model ChimeLog {
  id          String   @id @default(uuid())
  ruleId      String
  teamId      String
  triggeredAt DateTime @default(now())
  outcome     String   // 'success' | 'cooldown' | 'error'
  messageId   String?  // ID of message created (if applicable)
  insightId   String?  // ID of insight created (if applicable)
  confidence  Float?   // Confidence score of the match
  errorMsg    String?  // Error message if outcome='error'
  
  rule        ChimeRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId, triggeredAt])
  @@index([ruleId, triggeredAt])
}